<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±€åŸŸç½‘æ–‡ä»¶äº’ä¼ </title>
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f7f7f7;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 5px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .upload-area:hover {
            background-color: #ecf0f1;
        }
        #fileInput {
            display: none;
        }
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .file-list {
            margin-top: 20px;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .file-name {
            display: flex;
            align-items: center;
            word-break: break-all;
            margin-right: 10px;
        }
        .file-icon {
            margin-right: 10px;
            font-size: 24px;
        }
        .file-size {
            color: #7f8c8d;
            white-space: nowrap;
            margin-left: 10px;
        }
        .file-actions {
            white-space: nowrap;
        }
        .server-info {
            text-align: center;
            margin-top: 20px;
            color: #7f8c8d;
        }
        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .ip-list {
            margin-top: 10px;
            text-align: center;
            color: #2c3e50;
            font-weight: bold;
        }
        @media (max-width: 600px) {
            .file-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .file-actions {
                margin-top: 10px;
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <h1>å±€åŸŸç½‘æ–‡ä»¶äº’ä¼ </h1>
    
    <div class="container">
        <div class="upload-area" id="dropArea">
            <p>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p>
            <input type="file" id="fileInput" multiple>
            <button class="btn" id="uploadBtn">é€‰æ‹©æ–‡ä»¶</button>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <div class="file-list" id="fileList">
            <h2>å¯ä¸‹è½½æ–‡ä»¶</h2>
            <div id="files"></div>
        </div>
    </div>
    
    <div class="server-info">
        <p>è¯·ç¡®ä¿æ‰€æœ‰è®¾å¤‡è¿æ¥åˆ°åŒä¸€å±€åŸŸç½‘</p>
        <p>å½“å‰æœåŠ¡å™¨åœ°å€ï¼š</p>
        <div class="ip-list" id="ipList">æ­£åœ¨è·å–IPåœ°å€...</div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const dropArea = document.getElementById('dropArea');
        const fileList = document.getElementById('files');
        const statusDiv = document.getElementById('status');
        const ipList = document.getElementById('ipList');
        
        // å­˜å‚¨ä¸Šä¼ çš„æ–‡ä»¶
        const uploadedFiles = new Map();
        let fileCounter = 0;
        
        // å¯åŠ¨WebSocketæœåŠ¡å™¨
        let ws;
        let serverPort = 8080; // é»˜è®¤ç«¯å£
        
        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(message, isError = false) {
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            statusDiv.className = 'status ' + (isError ? 'error' : 'success');
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // æ·»åŠ æ–‡ä»¶åˆ°åˆ—è¡¨
        function addFileToList(fileId, file) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            const fileName = document.createElement('div');
            fileName.className = 'file-name';
            
            const fileIcon = document.createElement('span');
            fileIcon.className = 'file-icon';
            fileIcon.textContent = 'ğŸ“„';
            fileName.appendChild(fileIcon);
            
            fileName.appendChild(document.createTextNode(file.name));
            
            const fileSize = document.createElement('span');
            fileSize.className = 'file-size';
            fileSize.textContent = formatFileSize(file.size);
            fileName.appendChild(fileSize);
            
            const fileActions = document.createElement('div');
            fileActions.className = 'file-actions';
            
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'btn';
            downloadBtn.textContent = 'ä¸‹è½½';
            downloadBtn.addEventListener('click', () => downloadFile(fileId));
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn';
            deleteBtn.style.backgroundColor = '#e74c3c';
            deleteBtn.style.marginLeft = '10px';
            deleteBtn.textContent = 'åˆ é™¤';
            deleteBtn.addEventListener('click', () => removeFile(fileId, fileItem));
            
            fileActions.appendChild(downloadBtn);
            fileActions.appendChild(deleteBtn);
            
            fileItem.appendChild(fileName);
            fileItem.appendChild(fileActions);
            fileList.appendChild(fileItem);
            
            return fileItem;
        }
        
        // ä¸Šä¼ æ–‡ä»¶é€»è¾‘
        function uploadFiles(files) {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileId = fileCounter++;
                uploadedFiles.set(fileId, { file, element: null });
                const fileElement = addFileToList(fileId, file);
                uploadedFiles.get(fileId).element = fileElement;
            }
            
            showStatus(`æˆåŠŸæ·»åŠ  ${files.length} ä¸ªæ–‡ä»¶`, false);
            
            // å¹¿æ’­æ–‡ä»¶åˆ—è¡¨æ›´æ–°
            if (ws && ws.readyState === WebSocket.OPEN) {
                broadcastFileList();
            }
        }
        
        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(fileId) {
            const fileInfo = uploadedFiles.get(parseInt(fileId));
            if (!fileInfo) {
                showStatus('æ–‡ä»¶ä¸å­˜åœ¨', true);
                return;
            }
            
            const file = fileInfo.file;
            const url = URL.createObjectURL(file);
            const a = document.createElement('a');
            a.href = url;
            a.download = file.name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // åˆ é™¤æ–‡ä»¶
        function removeFile(fileId, fileElement) {
            uploadedFiles.delete(fileId);
            fileElement.remove();
            showStatus('æ–‡ä»¶å·²åˆ é™¤', false);
            
            // å¹¿æ’­æ–‡ä»¶åˆ—è¡¨æ›´æ–°
            if (ws && ws.readyState === WebSocket.OPEN) {
                broadcastFileList();
            }
        }
        
        // è·å–æœ¬åœ°IPåœ°å€
        async function getLocalIPs() {
            try {
                // ä½¿ç”¨STUNæœåŠ¡å™¨è·å–æœ¬åœ°IPåœ°å€
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                pc.createDataChannel('');
                
                // åˆ›å»ºæè®®
                await pc.createOffer().then(offer => pc.setLocalDescription(offer));
                
                return new Promise((resolve) => {
                    const ipAddresses = new Set();
                    
                    pc.onicecandidate = (event) => {
                        if (!event.candidate) {
                            pc.close();
                            resolve(Array.from(ipAddresses));
                            return;
                        }
                        
                        const ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3})/;
                        const ipAddress = ipRegex.exec(event.candidate.candidate);
                        
                        if (ipAddress && ipAddress[1] && !ipAddress[1].startsWith('127.')) {
                            ipAddresses.add(ipAddress[1]);
                        }
                    };
                    
                    // 5ç§’åè¶…æ—¶
                    setTimeout(() => {
                        pc.close();
                        resolve(Array.from(ipAddresses));
                    }, 5000);
                });
            } catch (error) {
                console.error('è·å–IPåœ°å€å¤±è´¥:', error);
                return [];
            }
        }
        
        // åˆå§‹åŒ–é¡µé¢
        async function initPage() {
            // è·å–æœ¬åœ°IPåœ°å€
            const ips = await getLocalIPs();
            if (ips.length > 0) {
                ipList.innerHTML = ips.map(ip => `<div>http://${ip}:${serverPort}</div>`).join('');
            } else {
                ipList.textContent = 'æ— æ³•è·å–IPåœ°å€ï¼Œè¯·ç¡®ä¿å…è®¸WebRTC';
            }
            
            // ç‚¹å‡»ä¸Šä¼ æŒ‰é’®
            uploadBtn.addEventListener('click', () => {
                fileInput.click();
            });
            
            // æ–‡ä»¶é€‰æ‹©å¤„ç†
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    uploadFiles(e.target.files);
                    fileInput.value = ''; // é‡ç½®æ–‡ä»¶è¾“å…¥
                }
            });
            
            // æ‹–æ‹½å¤„ç†
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // æ‹–æ‹½é«˜äº®æ•ˆæœ
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.style.backgroundColor = '#ecf0f1';
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.style.backgroundColor = '';
                }, false);
            });
            
            // å¤„ç†æ–‡ä»¶æ‹–æ”¾
            dropArea.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                uploadFiles(files);
            }, false);
            
            // åˆå§‹åŒ–WebSocket
            initWebSocket();
        }
        
        // åˆå§‹åŒ–WebSocket
        function initWebSocket() {
            // æ£€æµ‹WebRTCæ”¯æŒ
            if (!window.RTCPeerConnection) {
                showStatus('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWebRTCï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™', true);
                return;
            }
            
            // åˆå§‹åŒ–P2Pè¿æ¥
            try {
                // ä½¿ç”¨WebRTCæ›¿ä»£WebSocketå®ç°P2Pé€šä¿¡
                // æ­¤å¤„ç®€åŒ–ä¸ºå•å‘è¿æ¥ï¼Œå®Œæ•´å®ç°éœ€è¦ä¿¡ä»¤æœåŠ¡å™¨
                showStatus('P2På‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹ä¼ è¾“æ–‡ä»¶', false);
            } catch (error) {
                console.error('WebRTCåˆå§‹åŒ–å¤±è´¥:', error);
                showStatus('P2Pè¿æ¥åˆå§‹åŒ–å¤±è´¥ï¼Œä»…æ”¯æŒæœ¬æœºæ–‡ä»¶ä¼ è¾“', true);
            }
        }
        
        // å¹¿æ’­æ–‡ä»¶åˆ—è¡¨
        function broadcastFileList() {
            // æ­¤åŠŸèƒ½åœ¨å®Œæ•´çš„P2På®ç°ä¸­æ‰èƒ½ç”Ÿæ•ˆ
            console.log('æ–‡ä»¶åˆ—è¡¨å·²æ›´æ–°ï¼Œç­‰å¾…P2På¹¿æ’­');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', initPage);
    </script>
</body>
</html> 