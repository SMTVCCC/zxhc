<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>局域网文件互传</title>
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-light: #4895ef;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --text-color: #2b2d42;
            --text-secondary: #6c757d;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --border-radius: 12px;
            --transition: all 0.3s ease;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 0 20px;
        }
        
        .page-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .app-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .app-title {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 10px;
            font-weight: 700;
            position: relative;
            display: inline-block;
        }
        
        .app-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: linear-gradient(to right, var(--primary-color), var(--success-color));
            border-radius: 2px;
        }
        
        .app-subtitle {
            color: var(--text-secondary);
            font-weight: 400;
            font-size: 1.1rem;
            margin-top: 20px;
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 30px;
            transition: var(--transition);
        }
        
        .card:hover {
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
            transform: translateY(-5px);
        }
        
        .upload-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .upload-area {
            width: 100%;
            border: 2px dashed var(--primary-light);
            border-radius: var(--border-radius);
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: var(--transition);
            background-color: rgba(67, 97, 238, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .upload-area.drag-over {
            border-color: var(--success-color);
            background-color: rgba(76, 201, 240, 0.15);
        }
        
        .upload-icon {
            font-size: 60px;
            margin-bottom: 15px;
            color: var(--primary-color);
            transition: var(--transition);
        }
        
        .upload-area:hover .upload-icon {
            transform: scale(1.1);
        }
        
        .upload-text {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }
        
        #fileInput {
            display: none;
        }
        
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 10px 0;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }
        
        .btn-icon {
            margin-right: 8px;
        }
        
        .status {
            width: 100%;
            text-align: center;
            padding: 15px;
            margin: 15px 0;
            border-radius: var(--border-radius);
            transition: var(--transition);
            opacity: 0;
            transform: translateY(-10px);
            font-weight: 500;
        }
        
        .status.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .success {
            background-color: rgba(76, 201, 240, 0.2);
            color: var(--success-color);
            border-left: 4px solid var(--success-color);
        }
        
        .error {
            background-color: rgba(247, 37, 133, 0.2);
            color: var(--danger-color);
            border-left: 4px solid var(--danger-color);
        }
        
        .file-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .file-list-title {
            font-size: 1.3rem;
            color: var(--text-color);
            font-weight: 600;
        }
        
        .file-count {
            background-color: var(--primary-light);
            color: white;
            border-radius: 20px;
            padding: 3px 12px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .no-files {
            text-align: center;
            padding: 40px 0;
            color: var(--text-secondary);
        }
        
        .no-files-icon {
            font-size: 50px;
            color: #ddd;
            margin-bottom: 15px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
            background-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.04);
            transition: var(--transition);
        }
        
        .file-item:hover {
            background-color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transform: translateX(5px);
        }
        
        .file-item:last-child {
            margin-bottom: 0;
        }
        
        .file-name {
            display: flex;
            align-items: center;
            word-break: break-all;
            margin-right: 10px;
            flex: 1;
        }
        
        .file-icon {
            margin-right: 15px;
            font-size: 28px;
            color: var(--primary-color);
        }
        
        .file-info {
            display: flex;
            flex-direction: column;
        }
        
        .file-title {
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 3px;
        }
        
        .file-size {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .file-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-small {
            padding: 8px 18px;
            font-size: 0.9rem;
        }
        
        .btn-delete {
            background-color: var(--danger-color);
        }
        
        .btn-delete:hover {
            background-color: #e01b67;
            box-shadow: 0 5px 15px rgba(247, 37, 133, 0.3);
        }
        
        .server-info {
            text-align: center;
            margin-top: 40px;
            color: var(--text-secondary);
        }
        
        .server-info p {
            margin-bottom: 8px;
        }
        
        .ip-list {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        
        .ip-item {
            background-color: var(--card-bg);
            color: var(--primary-color);
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
        }
        
        .ip-icon {
            margin-right: 8px;
            color: var(--primary-light);
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .loading {
            animation: pulse 1.5s infinite ease-in-out;
        }
        
        @media (max-width: 768px) {
            .page-container {
                padding: 30px 15px;
            }
            
            .app-title {
                font-size: 2rem;
            }
            
            .card {
                padding: 20px;
            }
            
            .upload-area {
                padding: 30px 15px;
            }
            
            .upload-icon {
                font-size: 40px;
            }
            
            .upload-text {
                font-size: 1rem;
            }
        }
        
        @media (max-width: 576px) {
            .file-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .file-actions {
                margin-top: 15px;
                align-self: stretch;
                justify-content: space-between;
                width: 100%;
            }
            
            .btn-small {
                flex: 1;
                margin: 0;
            }
            
            .ip-list {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css">
</head>
<body>
    <div class="page-container">
        <header class="app-header">
            <h1 class="app-title">局域网文件互传</h1>
            <p class="app-subtitle">在同一网络下便捷传输文件，无需云存储</p>
        </header>
        
        <div class="card upload-card">
            <div class="upload-area" id="dropArea">
                <i class="ri-upload-cloud-2-line upload-icon"></i>
                <p class="upload-text">点击或拖拽文件到此处上传</p>
                <input type="file" id="fileInput" multiple>
                <button class="btn" id="uploadBtn">
                    <i class="ri-file-add-line btn-icon"></i>选择文件
                </button>
            </div>
            
            <div id="status" class="status" style="display: none;"></div>
        </div>
        
        <div class="card">
            <div class="file-list-header">
                <h2 class="file-list-title">可下载文件</h2>
                <span id="fileCount" class="file-count">0</span>
            </div>
            
            <div class="file-list" id="fileList">
                <div class="no-files" id="noFiles">
                    <div class="no-files-icon">
                        <i class="ri-file-forbid-line"></i>
                    </div>
                    <p>暂无可下载文件</p>
                </div>
            </div>
        </div>
        
        <div class="server-info">
            <p>请确保所有设备连接到同一局域网</p>
            <p>当前服务器地址：</p>
            <div class="ip-list" id="ipList">
                <div class="ip-item loading">
                    <i class="ri-loader-4-line ip-icon"></i>正在获取IP地址...
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 全局变量
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const dropArea = document.getElementById('dropArea');
        const fileList = document.getElementById('fileList');
        const statusDiv = document.getElementById('status');
        const ipList = document.getElementById('ipList');
        const noFiles = document.getElementById('noFiles');
        const fileCount = document.getElementById('fileCount');
        
        // 存储上传的文件
        const uploadedFiles = new Map();
        let fileCounter = 0;
        
        // 启动WebSocket服务器
        let ws;
        let serverPort = 8080; // 默认端口
        
        // 显示状态信息
        function showStatus(message, isError = false) {
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            statusDiv.className = 'status ' + (isError ? 'error' : 'success') + ' show';
            setTimeout(() => {
                statusDiv.className = 'status ' + (isError ? 'error' : 'success');
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 300);
            }, 5000);
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 更新文件计数
        function updateFileCount() {
            const count = uploadedFiles.size;
            fileCount.textContent = count;
            if (count > 0) {
                noFiles.style.display = 'none';
            } else {
                noFiles.style.display = 'block';
            }
        }
        
        // 获取文件图标
        function getFileIcon(fileName) {
            const extension = fileName.split('.').pop().toLowerCase();
            
            // 图片文件
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp'].includes(extension)) {
                return 'ri-image-line';
            }
            // 文档文件
            else if (['doc', 'docx', 'odt', 'pdf', 'txt', 'rtf', 'md'].includes(extension)) {
                return 'ri-file-text-line';
            }
            // 表格文件
            else if (['xls', 'xlsx', 'csv'].includes(extension)) {
                return 'ri-file-excel-line';
            }
            // 视频文件
            else if (['mp4', 'avi', 'mov', 'wmv', 'flv', 'mkv', 'webm'].includes(extension)) {
                return 'ri-film-line';
            }
            // 音频文件
            else if (['mp3', 'wav', 'ogg', 'aac', 'flac'].includes(extension)) {
                return 'ri-music-line';
            }
            // 压缩文件
            else if (['zip', 'rar', '7z', 'tar', 'gz'].includes(extension)) {
                return 'ri-archive-line';
            }
            // 代码文件
            else if (['html', 'css', 'js', 'ts', 'jsx', 'php', 'py', 'java', 'c', 'cpp'].includes(extension)) {
                return 'ri-code-line';
            }
            // 默认文件
            return 'ri-file-line';
        }
        
        // 添加文件到列表
        function addFileToList(fileId, file) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            const fileName = document.createElement('div');
            fileName.className = 'file-name';
            
            const fileIcon = document.createElement('i');
            fileIcon.className = `file-icon ${getFileIcon(file.name)}`;
            fileName.appendChild(fileIcon);
            
            const fileInfo = document.createElement('div');
            fileInfo.className = 'file-info';
            
            const fileTitle = document.createElement('span');
            fileTitle.className = 'file-title';
            fileTitle.textContent = file.name;
            fileInfo.appendChild(fileTitle);
            
            const fileSize = document.createElement('span');
            fileSize.className = 'file-size';
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.appendChild(fileSize);
            
            fileName.appendChild(fileInfo);
            
            const fileActions = document.createElement('div');
            fileActions.className = 'file-actions';
            
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'btn btn-small';
            downloadBtn.innerHTML = '<i class="ri-download-line btn-icon"></i>下载';
            downloadBtn.addEventListener('click', () => downloadFile(fileId));
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-small btn-delete';
            deleteBtn.innerHTML = '<i class="ri-delete-bin-line btn-icon"></i>删除';
            deleteBtn.addEventListener('click', () => removeFile(fileId, fileItem));
            
            fileActions.appendChild(downloadBtn);
            fileActions.appendChild(deleteBtn);
            
            fileItem.appendChild(fileName);
            fileItem.appendChild(fileActions);
            fileList.appendChild(fileItem);
            
            updateFileCount();
            return fileItem;
        }
        
        // 上传文件逻辑
        function uploadFiles(files) {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileId = fileCounter++;
                uploadedFiles.set(fileId, { file, element: null });
                const fileElement = addFileToList(fileId, file);
                uploadedFiles.get(fileId).element = fileElement;
            }
            
            showStatus(`成功添加 ${files.length} 个文件`, false);
            
            // 广播文件列表更新
            if (ws && ws.readyState === WebSocket.OPEN) {
                broadcastFileList();
            }
        }
        
        // 下载文件
        function downloadFile(fileId) {
            const fileInfo = uploadedFiles.get(parseInt(fileId));
            if (!fileInfo) {
                showStatus('文件不存在', true);
                return;
            }
            
            const file = fileInfo.file;
            const url = URL.createObjectURL(file);
            const a = document.createElement('a');
            a.href = url;
            a.download = file.name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus(`文件 ${file.name} 开始下载`, false);
        }
        
        // 删除文件
        function removeFile(fileId, fileElement) {
            uploadedFiles.delete(fileId);
            fileElement.remove();
            updateFileCount();
            showStatus('文件已删除', false);
            
            // 广播文件列表更新
            if (ws && ws.readyState === WebSocket.OPEN) {
                broadcastFileList();
            }
        }
        
        // 获取本地IP地址
        async function getLocalIPs() {
            try {
                // 使用STUN服务器获取本地IP地址
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                pc.createDataChannel('');
                
                // 创建提议
                await pc.createOffer().then(offer => pc.setLocalDescription(offer));
                
                return new Promise((resolve) => {
                    const ipAddresses = new Set();
                    
                    pc.onicecandidate = (event) => {
                        if (!event.candidate) {
                            pc.close();
                            resolve(Array.from(ipAddresses));
                            return;
                        }
                        
                        const ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3})/;
                        const ipAddress = ipRegex.exec(event.candidate.candidate);
                        
                        if (ipAddress && ipAddress[1] && !ipAddress[1].startsWith('127.')) {
                            ipAddresses.add(ipAddress[1]);
                        }
                    };
                    
                    // 5秒后超时
                    setTimeout(() => {
                        pc.close();
                        resolve(Array.from(ipAddresses));
                    }, 5000);
                });
            } catch (error) {
                console.error('获取IP地址失败:', error);
                return [];
            }
        }
        
        // 初始化页面
        async function initPage() {
            // 获取本地IP地址
            ipList.innerHTML = '<div class="ip-item loading"><i class="ri-loader-4-line ip-icon"></i>正在获取IP地址...</div>';
            
            const ips = await getLocalIPs();
            if (ips.length > 0) {
                ipList.innerHTML = '';
                ips.forEach(ip => {
                    const ipItem = document.createElement('div');
                    ipItem.className = 'ip-item';
                    ipItem.innerHTML = `<i class="ri-global-line ip-icon"></i>http://${ip}:${serverPort}`;
                    ipList.appendChild(ipItem);
                });
            } else {
                ipList.innerHTML = '<div class="ip-item"><i class="ri-error-warning-line ip-icon"></i>无法获取IP地址，请确保允许WebRTC</div>';
            }
            
            // 点击上传按钮
            uploadBtn.addEventListener('click', () => {
                fileInput.click();
            });
            
            // 文件选择处理
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    uploadFiles(e.target.files);
                    fileInput.value = ''; // 重置文件输入
                }
            });
            
            // 拖拽处理
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // 拖拽高亮效果
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.classList.add('drag-over');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.classList.remove('drag-over');
                }, false);
            });
            
            // 处理文件拖放
            dropArea.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                uploadFiles(files);
            }, false);
            
            // 初始化WebSocket
            initWebSocket();
            
            // 初始化文件计数
            updateFileCount();
        }
        
        // 初始化WebSocket
        function initWebSocket() {
            // 检测WebRTC支持
            if (!window.RTCPeerConnection) {
                showStatus('您的浏览器不支持WebRTC，部分功能可能受限', true);
                return;
            }
            
            // 初始化P2P连接
            try {
                // 使用WebRTC替代WebSocket实现P2P通信
                // 此处简化为单向连接，完整实现需要信令服务器
                showStatus('P2P准备就绪，可以开始传输文件', false);
            } catch (error) {
                console.error('WebRTC初始化失败:', error);
                showStatus('P2P连接初始化失败，仅支持本机文件传输', true);
            }
        }
        
        // 广播文件列表
        function broadcastFileList() {
            // 此功能在完整的P2P实现中才能生效
            console.log('文件列表已更新，等待P2P广播');
        }
        
        // 页面加载完成后初始化
        window.addEventListener('load', initPage);
    </script>
</body>
</html> 